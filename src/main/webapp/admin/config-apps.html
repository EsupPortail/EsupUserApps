<!doctype html>
<html>
  <head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

    <style>
      a { white-space: nowrap; }
      img { width: 40px; height: 40px; }
      .tags { font-size: 60%; }
    </style>
  </head>
<body>

<script> window.prolongation_ENT_args = { delegateAuth: true }; </script>
<script src="/ProlongationENT/loader.js" type="text/javascript"></script>

<div id="list"></div>

<script>
"use strict";

function xhr(url, callback) {
    let req = new XMLHttpRequest();
    if (!req) return;
    req.open("GET", url, true);
    req.onreadystatechange = function () {
        if (req.readyState != 4) return;
        if (req.status == 401) {
           document.location = '/ProlongationENT/login?target=' + encodeURIComponent(document.location);
        } else if (req.status != 200) {
            alert('HTTP error ' + req.status);
            return;
        } else {
            callback(req.responseText);
        }
    }
    req.send(null);
}

function tr_th(l) {
    return "<tr>" + l.map(e => `<th>${e}</th>`).join('') + "</tr>";
}
function tr_td(l) {
    return "<tr>" + l.map(e => `<td>${e}</td>`).join('') + "</tr>";
}

function a(url, text) {
    return `<a href='${encodeURI(url)}'>${text}</a>`;
}

let grouper_url = 'https://grouper.univ-paris1.fr/grouper/grouperUi/app/UiV2Main.index?operation=UiV2Group.viewGroup&membershipType=immediate&groupName=';

let conf;

 function simplifyFname(k) {
   k = k.replace(/^C([A-Z])/, "$1").replace(/-(etu|ens|gest|pers|teacher|default)$/, '');
   return k.toLowerCase();
 }

 function format_groups(groups) {
   return (groups || []).map(group => {
     if (conf.GROUPS[group]) {
       return group;
     } else {
       return a(grouper_url + group.replace(/\./g, ":"), group);
     }
   }).join('<br>');
 }

function format_app(folder, id) {
    let app = conf.APPS[id];
    let url = app.url.replace("{fname}", id);
    let tags = app.tags ? `<p class="tags">Tags : ${app.tags.join(", ")}</p>` : '';
    let l = [folder, 
             "<img src='../theme-paris1-2016/icon/" + simplifyFname(id) + ".svg' onerror='this.hidden = true'>",
             a(url, id), app.shortText, (app.text ? app.text + "<br>" : '') + (app.title || ''),
             (app.description || '&nbsp;') + tags, format_groups(app.groups)];
    return tr_td(l.map(s => s || ''));
 }
 
function format() {
    let tbodies = Object.keys(conf.LAYOUT).map(folder => {
        let folderText = folder;
        let apps = conf.LAYOUT[folder].map(appId => {
            let s = format_app(folderText, appId);
            folderText = '-';
            return s;
        });
        return "<tbody>" + apps.join('') + "</tbody>";
    });
    let titles = [ "Onglet", "Ic√¥ne", "fname", "Titre court", "Text / Title", "Description", "Groups" ];
    return "<table class='table table-striped table-condensed table-bordered'>" +
        tr_th(titles) + tbodies.join('') + "</table>";
}
 
 xhr("config-apps.json", function (d) {
   conf = JSON.parse(d);
   document.getElementById("list").innerHTML = format();
 });
 
</script>

</body>
</html>
